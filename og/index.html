<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cronograma TDH++</title>
  <style>
    :root {
      --primary: #4A90E2;
      --bg: #FFFFFF;
      --surface: #F5F7FA;
      --text: #333333;
      --muted: #888888;
      --dark-bg: #1e1e1e;
      --dark-surface: #2a2a2a;
      --dark-text: #e0e0e0;
    }
    html.dark {
      --bg: var(--dark-bg);
      --surface: var(--dark-surface);
      --text: var(--dark-text);
    }
    * { box-sizing:border-box; margin:0; padding:0; }
    body { font-family:'Segoe UI',sans-serif; background:var(--surface); color:var(--text); display:flex; flex-direction:column; height:100vh; }
    header { background:var(--bg); padding:1rem; box-shadow:0 1px 4px rgba(0,0,0,0.1); display:flex; align-items:center; justify-content:space-between; }
    header h1 { font-size:1.25rem; }
    header .controls button { margin-left:.5rem; }
    nav { display:flex; background:var(--bg); overflow-x:auto; box-shadow:0 1px 4px rgba(0,0,0,0.05); }
    nav button { flex:1 0 auto; padding:.75rem 1rem; border:none; background:var(--bg); color:var(--muted); font-weight:500; cursor:pointer; transition:color .2s; }
    nav button.active { color:var(--primary); border-bottom:2px solid var(--primary); }
    main { flex:1; overflow-y:auto; position:relative; padding:1rem; }
    .tasks-wrapper { position:relative; padding-top:4rem; }
    #now-line { position:absolute; left:0; right:0; height:3px; background:rgba(255,0,0,0.8); z-index:998; transition:top .5s ease; }
    #now-label { position:absolute; left:12px; padding:4px 8px; background:rgba(255,0,0,0.9); color:#fff; font-size:.8rem; font-weight:600; border-radius:4px; transform:translateY(-50%); z-index:999; }
    #task-list { list-style:none; position:relative; z-index:2; }
    .task-item { background:var(--bg); margin-bottom:.5rem; padding:.75rem 1rem; border-left:4px solid var(--primary); border-radius:4px; display:flex; align-items:center; justify-content:space-between; opacity:0; transform:translateY(10px); animation:fadeIn .4s forwards; }
    .task-item.done .desc { text-decoration:line-through; opacity:.6; }
    .task-info { display:flex; align-items:center; }
    .task-info .time { font-weight:600; margin-right:1rem; cursor:pointer; }
    .task-info .desc { flex:1; }
    @keyframes fadeIn { to { opacity:1; transform:translateY(0);} }
    .fab { position:fixed; bottom:1.5rem; right:1.5rem; width:3.5rem; height:3.5rem; background:var(--primary); color:#fff; border:none; border-radius:50%; font-size:2rem; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.2); }
    .modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:2000; }
    .modal { background:var(--bg); padding:1.5rem; border-radius:6px; width:90%; max-width:360px; box-shadow:0 2px 10px rgba(0,0,0,0.3); }
    .modal h3 { margin-bottom:1rem; text-align:center; font-size:1.1rem; }
    .modal form { display:grid; gap:.75rem; }
    .modal label { font-size:.85rem; color:var(--text); }
    .modal input, .modal select { width:100%; padding:.5rem; border:1px solid #ccc; border-radius:4px; font-size:1rem; background:var(--bg); }
    .actions { display:flex; justify-content:flex-end; gap:.5rem; margin-top:1rem; }
    .btn { padding:.5rem 1rem; border:none; border-radius:4px; cursor:pointer; }
    .btn-primary { background:var(--primary); color:#fff; }
    .btn-secondary { background:#ddd; }
    .focus-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); display:none; flex-direction:column; align-items:center; justify-content:center; color:#fff; z-index:3000; }
    .focus-overlay h2 { margin-bottom:1rem; }
    .focus-overlay .timer { font-size:3rem; margin-bottom:1rem; }
  </style>
</head>
<body>
  <header>
    <h1>Cronograma TDH++</h1>
    <div class="controls">
      <button id="toggle-dark">üåì</button>
      <button id="export">‚¨áÔ∏è Exportar</button>
      <button id="import-btn">‚¨ÜÔ∏è Importar</button>
      <input type="file" id="import-file" accept="application/json" style="display:none;" />
    </div>
  </header>
  <nav id="day-nav"></nav>
  <main>
    <div class="tasks-wrapper">
      <div id="now-line"></div>
      <div id="now-label"></div>
      <ul id="task-list"></ul>
    </div>
  </main>
  <button class="fab" id="open-modal">+</button>

  <div class="modal-overlay" id="modal">
    <div class="modal">
      <h3>Nova Tarefa</h3>
      <form id="task-form">
        <label>Dia</label>
        <select id="task-day">
          <option value="domingo">Domingo</option>
          <option value="segunda">Segunda</option>
          <option value="terca">Ter√ßa</option>
          <option value="quarta">Quarta</option>
          <option value="quinta">Quinta</option>
          <option value="sexta">Sexta</option>
          <option value="sabado">S√°bado</option>
        </select>
        <label>Hor√°rio</label>
        <input type="time" id="task-time" required>
        <label>Descri√ß√£o</label>
        <input type="text" id="task-desc" placeholder="Ex: Reuni√£o" required>
        <div class="actions">
          <button type="button" class="btn btn-secondary" id="cancel">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>
  <div class="focus-overlay" id="focus-overlay">
    <h2 id="focus-title"></h2>
    <div class="timer" id="focus-timer"></div>
    <button class="btn btn-secondary" id="stop-focus">Parar</button>
  </div>

  <script>
    // Data and storage
    const KEY = 'tasks';
    const days = ['domingo','segunda','terca','quarta','quinta','sexta','sabado'];
    const defaultTasks = [ /* your defaultTasks here */ ];
    let tasks = JSON.parse(localStorage.getItem(KEY));
    if(!tasks) { tasks = defaultTasks; localStorage.setItem(KEY,JSON.stringify(tasks)); }
    let currentDay = new Date().getDay();

    // Elements
    const nav = document.getElementById('day-nav'),
          list = document.getElementById('task-list'),
          line = document.getElementById('now-line'),
          label= document.getElementById('now-label'),
          modal= document.getElementById('modal'),
          form = document.getElementById('task-form'),
          importFile = document.getElementById('import-file'),
          focusOverlay = document.getElementById('focus-overlay'),
          focusTitle = document.getElementById('focus-title'),
          focusTimer = document.getElementById('focus-timer'),
          btnDark = document.getElementById('toggle-dark');

    // Initialize nav
    days.forEach((d,i)=>{
      const btn = document.createElement('button');
      btn.textContent = d.charAt(0).toUpperCase()+d.slice(1);
      btn.classList.toggle('active',i===currentDay);
      btn.addEventListener('click',()=>{ currentDay=i; render(); });
      nav.appendChild(btn);
    });

    // Dark mode
    if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.classList.add('dark');
    btnDark.addEventListener('click', e=>document.documentElement.classList.toggle('dark'));

    function save(){ localStorage.setItem(KEY,JSON.stringify(tasks)); }

    // Export
    document.getElementById('export').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(tasks, null, 2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='tasks.json'; a.click(); URL.revokeObjectURL(url);
    });
    // Import
    document.getElementById('import-btn').addEventListener('click', ()=>importFile.click());
    importFile.addEventListener('change',e=>{
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{ try{ tasks = JSON.parse(reader.result); save(); render(); }catch{} };
      reader.readAsText(file);
    });

    // Render tasks
    function render(){
      Array.from(nav.children).forEach((b,i)=>b.classList.toggle('active',i===currentDay));
      list.innerHTML='';
      const todayTasks = tasks.filter(t=>t.day===days[currentDay]).sort((a,b)=>a.time.localeCompare(b.time));
      todayTasks.forEach(t=>{
        const li = document.createElement('li'); li.className='task-item';
        li.innerHTML = `<div class="task-info"><input type="checkbox" class="task-check"><div class="time">${t.time}</div><div class="desc">${t.desc}</div></div>`;
        const timeEl = li.querySelector('.time');
        // Pomodoro start on click time
        timeEl.addEventListener('click', ()=>startPomodoro(t));
        list.appendChild(li);
      });
      updateLine();
      scheduleNotifications(todayTasks);
    }

    // Time line
    function updateLine(){
      const now=new Date(), m=now.getHours()*60+now.getMinutes();
      label.textContent = now.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      const items = Array.from(list.children);
      let top = 0;
      items.forEach(c=>{
        const [h,min] = c.querySelector('.time').textContent.split(':').map(Number);
        if(m >= h*60+min) top = c.offsetTop + c.offsetHeight/2;
      });
      line.style.top = top+'px'; label.style.top = top+'px';
    }
    setInterval(updateLine,60000);

    // Notifications
    function scheduleNotifications(ts){
      if(!('Notification' in window)) return;
      Notification.requestPermission();
      ts.forEach(t=>{
        const [h,min] = t.time.split(':').map(Number);
        const notifyTime = new Date();
        notifyTime.setHours(h,min,0,0);
        const delay = notifyTime - new Date();
        if(delay>0) setTimeout(()=>new Notification('Hora de: '+t.desc), delay);
      });
    }

    // Pomodoro
    let pomInterval;
    function startPomodoro(task){
      clearInterval(pomInterval);
      focusTitle.textContent = 'Foco: '+task.desc;
      focusOverlay.style.display = 'flex';
      speak('Iniciando Pomodoro: '+task.desc);
      let seconds = 25*60;
      function update(){
        const m = String(Math.floor(seconds/60)).padStart(2,'0');
        const s = String(seconds%60).padStart(2,'0');
        focusTimer.textContent = m+':'+s;
        if(seconds > 0) {
          seconds--;  // decrement after updating display
          pomInterval = setTimeout(update, 1000);
        } else {
          speak('Pomodoro encerrado. Pausa de 5 minutos');
          seconds = 5*60;
          update();
        }
      }
      update();
    }
    document.getElementById('stop-focus').addEventListener('click', ()=>{ clearTimeout(pomInterval); focusOverlay.style.display='none'; });
    function speak(text){ if('speechSynthesis' in window) speechSynthesis.speak(new SpeechSynthesisUtterance(text)); }

    // Modal
    document.getElementById('open-modal').addEventListener('click', ()=>modal.style.display='flex');
    document.getElementById('cancel').addEventListener('click', ()=>modal.style.display='none');
    form.addEventListener('submit',e=>{
      e.preventDefault();
      tasks.push({ day:form['task-day'].value, time:form['task-time'].value, desc:form['task-desc'].value });
      save(); render(); modal.style.display='none'; form.reset();
    });

    // Keyboard shortcuts
    window.addEventListener('keydown', e=>{
      if(e.key==='N'||e.key==='n') document.getElementById('open-modal').click();
      if(e.key==='Escape') modal.style.display='none';
      if(e.key==='ArrowLeft') nav.children[(currentDay-1+7)%7].click();
      if(e.key==='ArrowRight') nav.children[(currentDay+1)%7].click();
    });

    // Init
    render();
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js');
    }
  </script>
</body>
</html>
